#cloud-config

# Hostname management
preserve_hostname: False
hostname: ci
fqdn: ci.local

swap:
  filename: /dev/vdb

# If there's a data disk
fs_setup:
  - label: data
    filesystem: ext4
    device: /dev/vdc

mounts:
#  This / fstab entry has to be present before boot to ensure the drive is mounted rw :/
#  - [ vda, /, "ext4", "rw,noatime,user_xattr,acl,barrier=1,data=ordered", "0", "0"]
  - [ vdb, none, "swap", none, "0", "0"]
  - [ vdc, /data, "ext4", "rw,noatime,user_xattr,acl,barrier=1,data=ordered", "0", "0"]

chpasswd:
  list: |
    root:skytree
  expire: False

zypper:
  repos:
    - id: obs_server_mer-2.5_42.1
      name: Mer OBS 2.5 on 42.1 (openSUSE_42.3)
      type: rpm-md
      baseurl: http://repo.merproject.org/obs/obs:/server:/mer-2.5:/42.1/openSUSE_42.3/
      gpgcheck: 0
      enabled: 1
      autorefresh: 1
      priority: 69
    - id: MINT
      name: MINT (openSUSE_42.3)
      baseurl: http://repo.merproject.org/obs/mint/openSUSE_42.3/
      enabled: 1
      gpgcheck: 0
      autorefresh: 1
      type: rpm-md
      priority: 69
    - id: mer-infra_stable
      name: Mer Infra stable (openSUSE_42.3)
      baseurl: http://repo.merproject.org/obs/mer-infra:/stable/openSUSE_42.3/
      enabled: 1
      gpgcheck: 0
      autorefresh: 1
      type: rpm-md
      priority: 69

package_update: true
package_upgrade: true
package_reboot_if_required: true
packages:
  - ca-certificates-mozilla
  - obs-api
  - obs-server
  - obs-service-tar-git
  - obs-worker
  - apache2
  - apache2-mod_xforward
  - rubygem-passenger-apache2
  - memcached

write_files:
  - path: /etc/zypp/zypper.conf
    owner: root:root
    permissions: '0644'
    content: |
      [solver]
      installRecommends = no

runcmd:
  - [ mkdir, /host ]
  - [ mount, -t, 9p, -o, "trans=virtio,version=9p2000.L", host0, /host ]
  - [ /host/run_scripts.sh ]
  - [ umount, /host ]
  - [ rmdir, /host ]
  - [ rpm, -e, cloud-init ]

final_message: "---- cloud-init finished ----"
